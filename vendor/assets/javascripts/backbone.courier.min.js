/*
 * Backbone.Courier, v0.5.9
 * Copyright (c)2013 Rotunda Software, LLC.
 * Distributed under MIT license
 * http://github.com/rotundasoftware/backbone.courier
*/
!function(a,b){var c=/^(\S+)\s*(.*)$/,d=b.isFunction($)?$("body")[0]:null;a.Courier={},a.Courier.add=function(e){function f(a){b.isFunction(a.$el.data)&&!a.$el.data("view")&&a.$el.data("view",a)}function g(a){var d=this.uiBindings||b.result(this,"ui");if(!d)return a;var e={};return b.each(a,function(a,f){var g=f.match(c),h=g[1],i=g[2];if(""!==i&&!b.isUndefined(d[i])){var j=d[i];f=h+" "+j}e[f]=a}),e}function h(a,d,e){var f=[];for(var g in a){var h=g.match(c),i=h[1],j=h[2],k=new RegExp(i.replace("*","[\\w]*"));k.test(d.name)&&(""===j||e._getChildViewNamed(j)===d.source)&&f.push({eventName:i,subviewName:j,value:a[g]})}return f.length>1&&(f=b.sortBy(f,function(a){var b=a.eventName.replace("*",""),c=""!==a.subviewName,d=(c?1e3:0)+b.length;return-d})),f.length?f[0].value:null}var i={delegateEvents:e.delegateEvents,setElement:e.setElement};e.spawn=function(a,c){if(b.isString(a))a={name:a,data:b.extend({},c)};else if(b.isUndefined(a.name))throw new Error("Undefined message name.");a.source=e,a.data=a.data||{};for(var d,f,g="!"===a.name[a.name.length-1],i=this._getParentView();i;){if(b.isObject(i.onMessages)&&(f=h(i.onMessages,a,i),null!==f)){var j=f;if(b.isFunction(j)||(j=i[f]),!j)throw new Error('Method "'+f+'" does not exist');var k=j.call(i,a);if(g)return k}d=!1;var l=b.result(i,"passMessages");if(b.isObject(l))if(f=h(l,a,i),null!==f){if("."===f);else if(b.isString(f))a.name=f;else{if(!b.isFunction(f))throw new TypeError;var m=a.data;a.data={},f.call(i,a,m)}d=!0}else g&&(d=!0);if(g&&(d=!0),!d)break;a.source=i,i=i._getParentView()}if(g)throw new Error('Round trip message "'+a.name+'" was not handled. All round trip messages must be handled.')},b.isFunction(e._getParentView)||(e._getParentView=function(){for(var b=null,c=this.$el.parent();c.length>0&&c[0]!==d;){var e=c.data("view");if(e&&e instanceof a.View){b=e;break}c=c.parent()}return b}),b.isFunction(e._getChildViewNamed)||(e._getChildViewNamed=function(a){return b.isObject(this.subviews)?this.subviews[a]:null}),e.delegateEvents=function(a){var d=this;b.isFunction(this.events)&&(this.events=this.events.call(this.events)),a=a||b.clone(this.events)||{},a=g.call(this,a);var e=b.result(this,"spawnMessages")||{};e=g.call(this,e),b.each(e,function(e,f){var g=f.match(c),h=g[1];g[2];var i=function(a){a&&a.preventDefault&&a.preventDefault(),a&&a.stopPropagation&&a.stopPropagation();var c;if(b.isFunction(e))c={name:h,data:{},source:d},e.call(this,c,a);else{if(!b.isString(e))throw new TypeError;c=e}this.spawn(c)};if(a[f]){var j=a[f];if(b.isFunction(j)||(j=d[a[f]]),!j)throw new Error('Method "'+a[f]+'" does not exist');a[f]=function(){j.apply(this,arguments),i.apply(this,arguments)}}else a[f]=i}),i.delegateEvents.call(this,a)},e.setElement=function(a,b){i.setElement.call(this,a,b),f(e)},f(e),e.delegateEvents()}}(Backbone,_);